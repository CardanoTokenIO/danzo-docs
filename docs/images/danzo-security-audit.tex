\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{hyperref}
\usepackage{array}
\usepackage{longtable}

% Page setup
\geometry{
    top=2.5cm,
    bottom=2.5cm,
    left=2.5cm,
    right=2.5cm
}

% Colors
\definecolor{danzoBlue}{RGB}{0,51,102}
\definecolor{danzoGreen}{RGB}{0,128,0}
\definecolor{danzoRed}{RGB}{204,0,0}
\definecolor{danzoOrange}{RGB}{255,165,0}
\definecolor{danzoGray}{RGB}{128,128,128}

% Header and footer
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\textcolor{danzoBlue}{\textbf{DANZO Protocol Security Audit}}}
\fancyhead[R]{\textcolor{danzoGray}{May 2025}}
\fancyfoot[C]{\textcolor{danzoGray}{\thepage}}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

% Hyperlink setup
\hypersetup{
    colorlinks=true,
    linkcolor=danzoBlue,
    filecolor=danzoBlue,
    urlcolor=danzoBlue,
    citecolor=danzoBlue,
    pdftitle={DANZO Security Audit Report},
    pdfauthor={Orca Labs Security Division}
}

\begin{document}

% Title page
\begin{titlepage}
    \centering
    \vspace*{2cm}
    
    {\Huge\bfseries\color{danzoBlue} DANZO Protocol}\\[0.5cm]
    {\LARGE\color{danzoGray} Security Audit Report}\\[2cm]
    
    {\Large Backend Infrastructure \& Financial Controls}\\[1cm]
    
    \begin{tabular}{ll}
        \textbf{Audit Period:} & January 2025 - May 2025 \\
        \textbf{Audit Firm:} & Orca Labs Security Division \\
        \textbf{Domain Assessed:} & danzo.gg \\
        \textbf{Report Date:} & May 9, 2025 \\
        \textbf{Blockchain:} & Cardano \\
        \textbf{Classification:} & Confidential \\
    \end{tabular}
    
    \vfill
    
    {\large\textcolor{danzoGray}{
        This report contains confidential and proprietary information.\\
        Distribution is restricted to authorized parties only.
    }}
    
\end{titlepage}

% Table of contents
\tableofcontents
\newpage

% Executive Summary
\section{Executive Summary}

\subsection{Purpose of the Audit}
This audit provides a comprehensive examination of the closed-source backend code for the decentralized application running on the Cardano blockchain under the domain \texttt{danzo.gg}. The primary goal is to identify any potential loopholes or vulnerabilities that malicious actors could exploit to extract liquidity or otherwise compromise the system.

\subsection{Overall Assessment}
Overall, the backend exhibits a \textbf{sound structural design}. However, we identified several security and reliability concerns that required immediate attention and have been successfully addressed during the audit process.

\subsection{Key Findings}
\begin{itemize}
    \item \textbf{No initial withdrawal limits}: Initially, the source code did not enforce any upper withdrawal thresholds, potentially allowing the entire liquidity to be withdrawn in a single transaction.
    \item \textbf{Audit-driven improvements}: As a direct result of the audit, withdrawal limits and multi-stage validation checks were introduced.
    \item \textbf{Triple-verification process}: Currently, every withdrawal undergoes a triple-verification procedure before final execution, significantly reducing the risk of large-scale unauthorized withdrawals.
\end{itemize}

\subsection{Risk Assessment Summary}
\begin{center}
\begin{tabular}{|l|c|l|}
\hline
\textbf{Risk Category} & \textbf{Level} & \textbf{Status} \\
\hline
Withdrawal Security & \textcolor{danzoGreen}{LOW} & Critical fixes implemented \\
Concurrency Control & \textcolor{danzoOrange}{MEDIUM} & Mitigated with file locking \\
Input Validation & \textcolor{danzoGreen}{LOW} & Enhanced validation added \\
External Dependencies & \textcolor{danzoGreen}{LOW} & Proper error handling in place \\
Code Maintainability & \textcolor{danzoOrange}{MEDIUM} & Recommendations provided \\
\hline
\end{tabular}
\end{center}

\section{Scope of Work}

\subsection{Code and Components Audited}
We examined the entire casino directory within the closed-source DANZO GitHub repository, focusing on:
\begin{itemize}
    \item Deposit and withdrawal mechanisms
    \item Profit management systems
    \item Concurrency control functionality
    \item External API integrations
    \item Database security implementations
\end{itemize}

\subsection{Exclusions}
Our review was limited to the custom backend transaction-handling logic. The following components were outside the scope of this audit:
\begin{itemize}
    \item Integrated libraries (native Python modules, PyCardano, Emurgo support libraries)
    \item Game logic and randomization algorithms
    \item Frontend user interface components
    \item Third-party service implementations
\end{itemize}

\subsection{Time Frame}
\begin{itemize}
    \item \textbf{Audit Commencement}: January 2025
    \item \textbf{Audit Completion}: May 2025
    \item \textbf{Report Finalization}: May 9, 2025
\end{itemize}

\section{Methodology}

\subsection{Review Process}
\subsubsection{Manual Code Review and Developer Interviews}
We conducted an extensive manual review of the codebase, supplemented by interviews with developers to clarify areas involving complex Cardano blockchain logic.

\subsubsection{Environment and Testing}
\begin{itemize}
    \item \textbf{Primary Testing}: Dedicated testnet environment
    \item \textbf{Live Monitoring}: Continuous monitoring of live logs and behavior on mainnet
    \item \textbf{Operational Continuity}: Application remained operational throughout the audit period
\end{itemize}

\subsection{Risk Rating Methodology}
In this audit, we used a simplified two-tier risk classification system:

\begin{itemize}
    \item \textbf{\textcolor{danzoRed}{High}}: Represents serious issues that, if exploited, could lead to significant financial, security, or operational harm. These require immediate attention and remediation.
    \item \textbf{\textcolor{danzoGray}{Not Important}}: Designates minor or negligible concerns that pose little to no immediate risk. They may be addressed at the discretion of the development team.
\end{itemize}

\section{Detailed Findings}

\subsection{Architecture Overview}
The backend is primarily organized around a continuous transaction-handling loop that monitors incoming operations and processes them in real time. The architecture consists of five major components:

\subsubsection{Main Transaction Handler (Callback)}
\begin{itemize}
    \item Reads newly processed transaction references
    \item Evaluates operation type (deposit, withdrawal, liquidity update)
    \item Invokes utility functions for validation (\texttt{get\_balance}, \texttt{getWithdrawableBalance})
    \item Constructs Cardano transactions via PyCardano
    \item Updates database balances to credit or debit player accounts
\end{itemize}

\subsubsection{Liquidity \& Profit Management}
\textbf{Deposit/Withdrawal Routines:}
\begin{itemize}
    \item \texttt{Process\_ADA\_Deposit}: Manages liquidity deposits in ADA with secure database tracking
    \item \texttt{withdraw\_casino\_liquidity}: Handles liquidity removal with penalty checks for early withdrawals
\end{itemize}

\textbf{Casino Profit Tracking:}
\begin{itemize}
    \item Calculates total liquidity and potential profits at regular intervals
    \item Records token-specific profits (e.g., DANZO) in secure JSON files
    \item Implements concurrency controls to prevent race conditions
\end{itemize}

\subsubsection{Reward Distribution}
\begin{itemize}
    \item \texttt{Distribute\_rewards}: Calculates profit distribution after threshold periods (e.g., five days)
    \item \texttt{Map\_profits\_to\_participants}: Determines proportional payouts
    \item Integration with ORCA LABS engine for final disbursement
\end{itemize}

\subsubsection{Concurrency \& File-Based State}
\begin{itemize}
    \item \texttt{fcntl}-based file locking to prevent race conditions
    \item MongoDB for player balances and transaction logs
    \item JSON files for supplemental and historical tracking
\end{itemize}

\subsubsection{Supporting Modules and Checks}
\begin{itemize}
    \item \textbf{Cooldown \& High-Value Logic}: Functions like \texttt{can\_withdraw} and \texttt{is\_token\_high\_value} apply configurable thresholds
    \item \textbf{Statistics \& Analytics}: Hall of Fame generation and player performance tracking
    \item \textbf{External Notifications}: Integration with Discord, Twitter, and Mailjet for event broadcasting
\end{itemize}

\subsection{External Services and Dependencies}

\subsubsection{BlockFrost API}
\begin{itemize}
    \item Primary service for querying on-chain Cardano data
    \item Implements primary and fallback project IDs for redundancy
    \item Handles transaction submission to Cardano mainnet
\end{itemize}

\subsubsection{PyCardano}
\begin{itemize}
    \item Python library for Cardano transaction building and signing
    \item Manages low-level transaction assembly and key generation
    \item Handles blockchain interaction protocols
\end{itemize}

\subsubsection{TapTools API}
\begin{itemize}
    \item Provides live token price data (ADA/USD)
    \item Enables real-time risk assessment for large transactions
    \item Supports automated decision-making for withdrawal blocking
\end{itemize}

\subsubsection{Communication Services}
\begin{itemize}
    \item \textbf{Mailjet/SMTP}: Automated notifications and admin alerts
    \item \textbf{Tweepy}: Twitter integration for milestone announcements
    \item \textbf{Discord API}: Real-time updates and logging to Discord channels
\end{itemize}

\subsubsection{Database Infrastructure}
\begin{itemize}
    \item \textbf{MongoDB}: Primary storage for player balances and transaction histories
    \item Secure connection URI management
    \item Integration via pymongo client library
\end{itemize}

\subsection{Security Controls Implementation}

\subsubsection{Credential Management}
\begin{itemize}
    \item Keys and passwords stored securely in environment variables
    \item Isolated virtual machine environment
    \item Restricted SSH access for authorized administrators only
    \item Encrypted vault storage for sensitive credentials
\end{itemize}

\subsubsection{Network Security}
\begin{itemize}
    \item All external API calls made over HTTPS
    \item Comprehensive exception handling for service downtime
    \item Robust error management for transient failures
\end{itemize}

\subsubsection{Concurrency Protection}
\begin{itemize}
    \item File locking (\texttt{fcntl}) for JSON file operations
    \item Prevention of race conditions in multi-process environments
    \item Exclusive locks for critical state updates
\end{itemize}

\section{Security Assessment}

\subsection{Transaction Validations}

\subsubsection{ADA vs. Custom Tokens}
The system implements differentiated handling for ADA (lovelace) and custom tokens:

\begin{itemize}
    \item \textbf{Deposit Limits}: Enforced minimum (\texttt{min\_ada\_deposit}) and maximum (\texttt{max\_ada\_deposit}) thresholds
    \item \textbf{Prior State}: No upper withdrawal limits existed initially
    \item \textbf{Post-Audit Implementation}: Upper withdrawal limits and multi-step verification introduced
\end{itemize}

\subsubsection{Enhanced Validation Controls}
\begin{itemize}
    \item \textbf{Cooldown Duration}: X-hour windows prevent rapid successive withdrawals
    \item \textbf{ADA Threshold}: Yk ADA equivalent limits for large transactions
    \item \textbf{Cumulative Tracking}: System monitors total withdrawals within time windows
    \item \textbf{Admin Alerts}: Automatic notifications when thresholds are exceeded
\end{itemize}

\subsection{Identified Vulnerabilities and Mitigations}

\subsubsection{Withdrawal Bypass Protection}
\textbf{Concern}: Potential for attackers to split large withdrawals into smaller transactions to circumvent limits.

\textbf{Current Safeguards}:
\begin{itemize}
    \item Cumulative withdrawal tracking via \texttt{can\_withdraw} function
    \item Denial of attempts exceeding threshold within cooldown window
    \item Triple-verification process for all withdrawal requests
\end{itemize}

\textbf{Severity}: \textcolor{danzoGreen}{Mitigated} - No direct bypass mechanisms identified

\subsubsection{Race Condition Management}
\textbf{Risk}: Simultaneous deposits/withdrawals in high-concurrency environments

\textbf{Mitigation}:
\begin{itemize}
    \item \texttt{fcntl.flock} implementation for file-level protection
    \item Exclusive locking during critical operations
    \item Careful sequencing of read/write operations
\end{itemize}

\textbf{Assessment}: \textcolor{danzoOrange}{Medium Risk} for future scalability

\subsubsection{Replay Attack Prevention}
\textbf{Protection Mechanism}:
\begin{itemize}
    \item Processed transaction log maintenance
    \item Duplicate transaction hash detection
    \item Automatic rejection of previously processed transactions
\end{itemize}

\textbf{Recommendation}: Implement periodic log rotation and pruning

\subsubsection{Input Validation Enhancement}
\textbf{Previous Vulnerability}: Franken-address attacks were possible

\textbf{Current Status}: \textcolor{danzoGreen}{Patched} - Comprehensive address validation implemented

\textbf{Ongoing Measures}:
\begin{itemize}
    \item Enhanced address format verification
    \item Authorization checks for restricted operations
    \item Integration with BlockFrost API for address validation
\end{itemize}

\section{Code Quality Assessment}

\subsection{Coding Standards}
\begin{itemize}
    \item \textbf{Consistency}: Generally uniform function and variable naming
    \item \textbf{Areas for Improvement}: Function length optimization and configuration centralization
    \item \textbf{Priority Level}: Low (proprietary codebase not intended for open-source release)
\end{itemize}

\subsection{Documentation and Comments}
\begin{itemize}
    \item \textbf{Current State}: Inline comments explain most function parameters and return types
    \item \textbf{Enhancement Needed}: Complex multi-step logic requires more detailed documentation
    \item \textbf{Specific Areas}: Concurrency handling and data validation steps
\end{itemize}

\subsection{Error Handling and Logging}
\begin{itemize}
    \item \textbf{Strengths}: Comprehensive try-except blocks with retry logic
    \item \textbf{Improvement Area}: Centralized logging framework needed
    \item \textbf{Recommendation}: Replace print statements with structured logging (DEBUG/INFO/WARN/ERROR)
\end{itemize}

\subsection{Modularity Assessment}
\textbf{Current Separation}:
\begin{itemize}
    \item Transaction building logic
    \item Withdrawal validation checks
    \item External notification systems
\end{itemize}

\textbf{Recommended Improvements}:
\begin{itemize}
    \item Separate transaction service from notification service
    \item Unified Alert interface for multiple communication channels
    \item Enhanced service boundary definitions
\end{itemize}

\section{Remediation and Recommendations}

\subsection{Immediate Changes Implemented}
\begin{enumerate}
    \item \textbf{Cooldown Logic \& Withdrawal Limits}: X-hour window restrictions and threshold enforcement
    \item \textbf{Concurrency Locking}: File locks around JSON write operations
    \item \textbf{Enhanced Notifications}: Administrative alerts for threshold violations
    \item \textbf{Triple-Verification Process}: Multi-stage validation for all withdrawals
    \item \textbf{Address Validation}: Franken-address attack prevention
\end{enumerate}

\subsection{Short-Term Recommendations}
\begin{enumerate}
    \item \textbf{Unified Logging System}: Implement Python logging framework with appropriate levels
    \item \textbf{Enhanced Input Validation}: Strengthen validation for all user-facing routes
    \item \textbf{Configuration Management}: Centralize constants and threshold values
    \item \textbf{Error Handling Standardization}: Unified retry/backoff mechanism for external services
\end{enumerate}

\subsection{Long-Term Recommendations}
\begin{enumerate}
    \item \textbf{Database-Centric Concurrency}: Migrate to MongoDB transactions for scalable concurrency control
    \item \textbf{Automated Testing \& CI/CD}: Increase code coverage with comprehensive test suites
    \item \textbf{Security Program Expansion}: Consider bug bounty program for ongoing vulnerability discovery
    \item \textbf{Performance Optimization}: Address scalability concerns for high-volume transaction processing
\end{enumerate}

\section{Testing and Validation}

\subsection{Testing Methodology}
\begin{itemize}
    \item \textbf{Environment}: Dedicated Cardano testnet
    \item \textbf{Live Monitoring}: Continuous mainnet observation
    \item \textbf{Concurrency Testing}: Multi-process transaction simulation
    \item \textbf{Edge Case Analysis}: Boundary condition testing
\end{itemize}

\subsection{Validation Results}
\begin{itemize}
    \item \textbf{Withdrawal Limits}: Successfully prevent liquidity drainage
    \item \textbf{Cooldown Mechanisms}: Effective against rapid withdrawal attempts
    \item \textbf{File Locking}: Prevents race conditions in current implementation
    \item \textbf{External API Integration}: Robust error handling and failover
\end{itemize}

\section{Conclusion}

\subsection{Overall Security Posture}
With the newly introduced withdrawal limits, cooldown mechanisms, and improved validation checks, the backend now offers \textbf{significantly stronger defenses} against large-scale unauthorized withdrawals. Critical liquidity management functionalities have been fortified to prevent system drainage through single transactions or rapid transaction sequences.

\subsection{Key Achievements}
\begin{itemize}
    \item \textbf{Critical Fixes Implemented}:
    \begin{itemize}
        \item Withdrawal thresholds and cooldown periods
        \item File locking and enhanced validation checks
        \item Triple-verification process for withdrawals
    \end{itemize}
    \item \textbf{Identified Strengths}:
    \begin{itemize}
        \item Consistent code structure and naming conventions
        \item Current dependencies with minimal vulnerability exposure
        \item Robust external API integration with proper error handling
    \end{itemize}
\end{itemize}

\subsection{Next Steps}
\begin{enumerate}
    \item \textbf{Periodic Security Audits}: Schedule follow-up audits within 6-12 months
    \item \textbf{Scalability Planning}: Implement database-centric concurrency for future growth
    \item \textbf{Continuous Monitoring}: Regular review of API keys, dependencies, and system logs
    \item \textbf{Security Program Enhancement}: Consider formal bug bounty implementation
\end{enumerate}

\subsection{Final Risk Assessment}
\begin{center}
\begin{tabular}{|l|c|}
\hline
\textbf{Risk Category} & \textbf{Final Level} \\
\hline
Financial Security & \textcolor{danzoGreen}{LOW} \\
Operational Stability & \textcolor{danzoGreen}{LOW} \\
Code Maintainability & \textcolor{danzoOrange}{MEDIUM} \\
Scalability Readiness & \textcolor{danzoOrange}{MEDIUM} \\
External Dependencies & \textcolor{danzoGreen}{LOW} \\
\hline
\end{tabular}
\end{center}

\section{Disclaimer}

The application running on the domain \texttt{danzo.gg} comprises multiple components, many of which fell outside the scope of this audit. In particular, the entire game logic was excluded, as it emulates standard casino games using real-world probabilitiesâ€”an area the auditor could neither fully evaluate nor guarantee.

However, to the best of our knowledge, the application utilizes reputable libraries to ensure randomization, without incurring additional liability for their correctness. This audit focused exclusively on financial handling and critical security aspects. The game logic is assumed correct as a prerequisite, and we accept no responsibility for the accuracy of any game payouts; as with traditional casinos, payouts may be voided in the event of a malfunction.

Given the high-risk nature of this application, all interactions should be undertaken only after careful consideration of potential risks. Any modifications made to the audited backend repository after May 8th, 2025, were not assessed as part of this audit.

\vspace{2cm}

\noindent\textbf{Lead Security Auditor}\\
Orca Labs Security Division\\
May 9, 2025

\end{document}
